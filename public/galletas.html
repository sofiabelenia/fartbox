<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Ni√±a y las Galletas Explosivas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overflow: hidden;
            touch-action: none;
            background-color: #fce7f3; /* Pink-100 */
        }

        #game-area {
            position: relative;
            width: 100%;
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            cursor: none;
        }

        .girl {
            font-size: 60px; /* Reduced from 80px for mobile */
            position: absolute;
            bottom: 10px; /* Reduced from 20px */
            transform-origin: center bottom;
            transition: transform 0.1s;
            user-select: none;
            z-index: 10;
        }

        @media (min-width: 768px) {
            .girl {
                font-size: 80px; /* Original size on desktop */
                bottom: 20px;
            }
        }

        .cookie {
            font-size: 40px;
            position: absolute;
            user-select: none;
            animation: spin 2s linear infinite;
        }

        .particle {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
        }

        .fart-cloud {
            position: absolute;
            font-size: 60px;
            pointer-events: none;
            animation: fartPuff 1s ease-out forwards;
            opacity: 0;
        }

        @keyframes fartPuff {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) scale(1.5); }
            20%, 80% { transform: translate3d(2px, 0, 0) scale(1.5); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) scale(1.5); }
            40%, 60% { transform: translate3d(4px, 0, 0) scale(1.5); }
        }

        /* Barra de progreso personalizada */
        .bar-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <!-- UI Overlay -->
    <div id="ui-layer" class="absolute top-0 left-0 w-full p-4 z-20 pointer-events-none flex justify-between items-start">
        <div class="bg-white p-3 rounded-xl shadow-lg border-4 border-pink-300">
            <p class="text-xl font-bold text-pink-600">Puntos: <span id="score">0</span></p>
        </div>
        
        <div class="bg-white p-3 rounded-xl shadow-lg border-4 border-red-300 w-1/2 max-w-xs bar-container">
            <p class="text-sm font-bold text-red-500 mb-1">BARRIGA (¬°Cuidado!)</p>
            <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden border border-gray-300">
                <div id="fullness-bar" class="bg-green-500 h-6 rounded-full transition-all duration-200" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="start-screen" class="absolute inset-0 bg-black/60 z-50 flex flex-col items-center justify-center backdrop-blur-sm hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-md mx-4 border-8 border-pink-400">
            <h1 class="text-4xl font-extrabold text-pink-600 mb-2">¬°Galletas Explosivas!</h1>
            <div class="text-6xl mb-4">üëßüç™üí•</div>
            <p class="mb-6 text-gray-600 text-lg" id="game-over-msg">¬°EXPLOTASTE! üí®</p>
            <p class="mb-6 text-gray-600">Puntos: <span id="final-score" class="text-2xl font-bold text-pink-600">0</span></p>
            <button id="start-btn" class="bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white font-bold py-4 px-10 rounded-full text-2xl shadow-lg transform transition hover:scale-105 active:scale-95 w-full">
                Jugar de nuevo
            </button>
        </div>
    </div>

    <!-- Game Area -->
    <div id="game-area">
        <div id="player" class="girl" style="left: 50%;">üëß</div>
    </div>

    <script>
        // Configuraci√≥n del juego
        const state = {
            isPlaying: false,
            score: 0,
            fullness: 0,
            maxFullness: 100,
            digestionRate: 0.15, // Cu√°nto baja la barriga por frame
            cookieValue: 15,     // Cu√°nto llena una galleta
            spawnRate: 60,       // Frames entre galletas
            gameSpeed: 3,        // Velocidad de ca√≠da
            playerX: window.innerWidth / 2
        };

        // Elementos DOM
        const player = document.getElementById('player');
        const gameArea = document.getElementById('game-area');
        const scoreEl = document.getElementById('score');
        const fullnessBar = document.getElementById('fullness-bar');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const finalScoreEl = document.getElementById('final-score');

        let cookies = [];
        let particles = [];
        let frames = 0;
        let animationId;
        let audioCtx;
        let fartAudio;
        let keysPressed = {};
        let lastFartCloud = 0;

        // Cargar y reproducir el sonido de pedo desde archivo
        function playFartSound() {
            if (!fartAudio) {
                fartAudio = new Audio('peos/fart-sound-effect-16-11093.mp3');
            }
            fartAudio.currentTime = 0;
            fartAudio.play().catch(err => console.log('Error reproduciendo sonido:', err));
        }

        // Sonido de comer (pop simple)
        function playEatSound() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400, t);
            osc.frequency.exponentialRampToValueAtTime(600, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(t);
            osc.stop(t + 0.1);
        }

        // Inicializar Audio
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Input Handling
        function updatePlayerPosition(x) {
            state.playerX = x;
            // Limitar a la pantalla
            if (state.playerX < 40) state.playerX = 40;
            if (state.playerX > window.innerWidth - 40) state.playerX = window.innerWidth - 40;
            
            player.style.left = `${state.playerX - 40}px`; // Centrar el div
        }

        window.addEventListener('mousemove', (e) => {
            if (state.isPlaying) updatePlayerPosition(e.clientX);
        });

        window.addEventListener('touchmove', (e) => {
            if (state.isPlaying) {
                e.preventDefault();
                updatePlayerPosition(e.touches[0].clientX);
            }
        }, { passive: false });

        // Control con teclado (flechas)
        window.addEventListener('keydown', (e) => {
            if (!state.isPlaying) return;

            // Prevenir scroll con espacio
            if (e.key === ' ') {
                e.preventDefault();
                // Reproducir sonido solo la primera vez que se presiona (no repetir)
                if (!keysPressed[' ']) {
                    playFartSound();
                }
            }

            keysPressed[e.key] = true;
        });

        window.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
        });

        function createTurboFart(x, y) {
            const el = document.createElement('div');
            el.classList.add('fart-cloud');
            el.innerText = 'üí®';
            el.style.left = `${x - 30}px`;
            el.style.top = `${y}px`;
            el.style.fontSize = '30px'; // Reduced for mobile
            gameArea.appendChild(el);

            setTimeout(() => el.remove(), 1000);
        }

        function updateKeyboardMovement() {
            const baseSpeed = 8; // Velocidad de movimiento en p√≠xeles
            const turboMultiplier = 3; // Multiplicador de velocidad con turbo
            const isTurbo = keysPressed[' ']; // Turbo activado con espacio
            const moveSpeed = isTurbo ? baseSpeed * turboMultiplier : baseSpeed;

            if (keysPressed['ArrowLeft']) {
                state.playerX -= moveSpeed;
            }
            if (keysPressed['ArrowRight']) {
                state.playerX += moveSpeed;
            }

            // Limitar a la pantalla
            if (state.playerX < 40) state.playerX = 40;
            if (state.playerX > window.innerWidth - 40) state.playerX = window.innerWidth - 40;

            player.style.left = `${state.playerX - 40}px`;

            // Efecto visual de turbo con nubes de pedo
            if (isTurbo && (keysPressed['ArrowLeft'] || keysPressed['ArrowRight'])) {
                player.style.filter = 'blur(2px)';

                // Crear nubes de pedo detr√°s del personaje mientras se mueve
                const now = Date.now();
                if (now - lastFartCloud > 100) { // Crear nube cada 100ms
                    // Adjust position based on screen size
                    const bottomOffset = window.innerWidth < 768 ? 40 : 60;
                    createTurboFart(state.playerX, window.innerHeight - bottomOffset);
                    lastFartCloud = now;
                }
            } else {
                player.style.filter = 'none';
            }
        }

        // L√≥gica del Juego
        function startGame() {
            initAudio();
            state.isPlaying = true;
            state.score = 0;
            state.fullness = 0;
            state.gameSpeed = 3;
            cookies.forEach(c => c.element.remove());
            cookies = [];
            particles.forEach(p => p.element.remove());
            particles = [];
            
            scoreEl.innerText = '0';
            updateFullnessUI();
            
            player.classList.remove('shake');
            player.innerText = 'üëß';
            player.style.transform = 'scale(1)';
            player.style.opacity = '1';
            
            startScreen.classList.add('hidden');
            gameArea.style.cursor = 'none';
            
            gameLoop();
        }

        function createCookie() {
            const el = document.createElement('div');
            el.classList.add('cookie');
            el.innerText = 'üç™';
            const x = Math.random() * (window.innerWidth - 60) + 30;
            el.style.left = `${x}px`;
            el.style.top = '-50px';
            gameArea.appendChild(el);
            
            cookies.push({
                element: el,
                x: x,
                y: -50,
                speed: state.gameSpeed + (Math.random() * 2)
            });
        }

        function createExplosion(x, y) {
            // Cantidad muy reducida de part√≠culas
            const particleCount = 25; // Reducido de 50 a 25
            const emojis = ['üí®', 'üí•'];

            for (let i = 0; i < particleCount; i++) {
                const el = document.createElement('div');
                el.classList.add('particle');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];

                // Tama√±o fijo para mejor rendimiento
                el.style.fontSize = '40px';

                gameArea.appendChild(el);

                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 12 + 6;

                particles.push({
                    element: el,
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * velocity,
                    vy: Math.sin(angle) * velocity - 3,
                    life: 80 // Reducido de 120 a 80
                });
            }

            // Solo 2 nubes de pedo
            for (let i = 0; i < 2; i++) {
                const el = document.createElement('div');
                el.classList.add('fart-cloud');
                el.innerText = 'üí®';
                el.style.left = `${x - 30}px`;
                el.style.top = `${y - 30}px`;
                el.style.animationDelay = `${i * 0.2}s`;
                gameArea.appendChild(el);

                setTimeout(() => el.remove(), 1200);
            }
        }

        function gameOver() {
            state.isPlaying = false;
            cancelAnimationFrame(animationId);
            gameArea.style.cursor = 'default';

            // Efectos de explosi√≥n simple
            playFartSound();

            // Una sola explosi√≥n
            createExplosion(state.playerX, window.innerHeight - 50);

            // Sacudir la pantalla
            gameArea.style.animation = 'shake 0.5s';
            setTimeout(() => { gameArea.style.animation = ''; }, 500);

            // Ocultar jugadora original
            player.innerText = 'üí•';
            setTimeout(() => { player.style.opacity = '0'; }, 100);

            // Animar part√≠culas brevemente
            let explosionFrames = 0;
            function animateExplosion() {
                explosionFrames++;
                updateParticles();
                if (explosionFrames < 60) { // Muy reducido de 120 a 60
                    requestAnimationFrame(animateExplosion);
                } else {
                    // Limpiar part√≠culas restantes
                    particles.forEach(p => p.element.remove());
                    particles = [];
                    showGameOverScreen();
                }
            }
            animateExplosion();
        }

        function showGameOverScreen() {
            finalScoreEl.innerText = state.score;
            startScreen.classList.remove('hidden');
        }

        function updateFullnessUI() {
            fullnessBar.style.width = `${state.fullness}%`;
            
            // Cambiar color basado en la llenura
            if (state.fullness < 50) {
                fullnessBar.className = "h-6 rounded-full transition-all duration-200 bg-green-500";
                player.innerText = 'üëß';
            } else if (state.fullness < 80) {
                fullnessBar.className = "h-6 rounded-full transition-all duration-200 bg-yellow-400";
                player.innerText = 'üòã'; // Cara comiendo
            } else {
                fullnessBar.className = "h-6 rounded-full transition-all duration-200 bg-red-600";
                player.innerText = 'ü§¢'; // Cara enferma/llena
            }

            // Escalar la ni√±a seg√∫n lo llena que est√©
            const scale = 1 + (state.fullness / 200); // Max 1.5x
            player.style.transform = `scale(${scale})`;

            if (state.fullness > 85) {
                player.classList.add('shake');
            } else {
                player.classList.remove('shake');
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.5; // Gravedad
                p.life--;

                p.element.style.left = `${p.x}px`;
                p.element.style.top = `${p.y}px`;
                p.element.style.opacity = p.life / 80;

                if (p.life <= 0) {
                    p.element.remove();
                    particles.splice(i, 1);
                }
            }
        }

        function gameLoop() {
            if (!state.isPlaying) return;

            frames++;

            // Actualizar movimiento con teclado
            updateKeyboardMovement();

            // Digerir (bajar barra)
            if (state.fullness > 0) {
                state.fullness -= state.digestionRate;
                if (state.fullness < 0) state.fullness = 0;
            }

            // Spawnear galletas
            // Se hace m√°s dif√≠cil (m√°s r√°pido) a medida que pasa el tiempo
            const currentSpawnRate = Math.max(10, state.spawnRate - Math.floor(state.score / 50));
            if (frames % currentSpawnRate === 0) {
                createCookie();
            }

            // Mover galletas y colisiones
            const playerRect = player.getBoundingClientRect();
            // Hacemos el hitbox un poco m√°s peque√±o que el div visual para que sea justo
            const hitBox = {
                left: playerRect.left + 20,
                right: playerRect.right - 20,
                top: playerRect.top + 20,
                bottom: playerRect.bottom
            };

            for (let i = cookies.length - 1; i >= 0; i--) {
                const c = cookies[i];
                c.y += c.speed;
                c.element.style.top = `${c.y}px`;

                // Colisi√≥n
                const cookieRect = c.element.getBoundingClientRect();
                
                if (
                    cookieRect.left < hitBox.right &&
                    cookieRect.right > hitBox.left &&
                    cookieRect.bottom > hitBox.top &&
                    cookieRect.top < hitBox.bottom
                ) {
                    // COMER
                    state.score += 10;
                    scoreEl.innerText = state.score;
                    state.fullness += state.cookieValue;
                    playEatSound();
                    
                    c.element.remove();
                    cookies.splice(i, 1);

                    // Aumentar dificultad ligeramente
                    state.gameSpeed += 0.05;

                    // CHEQUEAR EXPLOSI√ìN
                    if (state.fullness >= 100) {
                        state.fullness = 100;
                        updateFullnessUI();
                        gameOver();
                        return;
                    }
                } 
                // Fuera de pantalla
                else if (c.y > window.innerHeight) {
                    c.element.remove();
                    cookies.splice(i, 1);
                }
            }

            updateFullnessUI();
            animationId = requestAnimationFrame(gameLoop);
        }

        // Listeners
        startBtn.addEventListener('click', startGame);

        // Ajustar tama√±o al cambiar ventana
        window.addEventListener('resize', () => {
             // Solo aseg√∫rate de que el jugador no quede fuera
             updatePlayerPosition(state.playerX);
        });

        // Iniciar autom√°ticamente el juego
        startGame();

    </script>
<script src="/game-wrapper.js"></script>
</body>
</html>